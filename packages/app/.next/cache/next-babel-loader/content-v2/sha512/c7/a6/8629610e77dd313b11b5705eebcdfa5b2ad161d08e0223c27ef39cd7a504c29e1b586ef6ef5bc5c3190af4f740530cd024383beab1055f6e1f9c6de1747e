{"ast":null,"code":"import { Fragment as _Fragment } from \"react/jsx-runtime\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport _defineProperty from \"/var/www/source/node_modules/next/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport _slicedToArray from \"/var/www/source/node_modules/next/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport _regeneratorRuntime from \"/var/www/source/node_modules/next/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/var/www/source/node_modules/next/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport { MinusCircleOutlined, QuestionCircleOutlined } from \"@ant-design/icons\";\nimport { API } from \"@koh/api-client\";\nimport { ERROR_MESSAGES } from \"@koh/common\";\nimport { Button, Form, Input, List, message, Switch, Tooltip } from \"antd\";\nimport { pick } from \"lodash\";\nimport { HeaderTitle } from \"./Styled\";\nimport React, { useEffect, useState } from \"react\";\nimport styled from \"styled-components\";\nimport useSWR from \"swr\";\nimport { getEndpoint, getNotificationState, NotificationStates, registerNotificationSubscription, requestNotificationPermission } from \"../../utils/notification\";\nvar DeviceAddHeader = styled.div.withConfig({\n  displayName: \"NotificationsSettings__DeviceAddHeader\",\n  componentId: \"sc-aypbgh-0\"\n})([\"display:flex;justify-content:space-between;\"]);\nexport default function NotificationsSettings() {\n  var _useSWR = useSWR(\"api/v1/profile\", /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            return _context.abrupt(\"return\", API.profile.index());\n\n          case 1:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }))),\n      profile = _useSWR.data,\n      mutate = _useSWR.mutate;\n\n  var _Form$useForm = Form.useForm(),\n      _Form$useForm2 = _slicedToArray(_Form$useForm, 1),\n      form = _Form$useForm2[0];\n\n  var editProfile = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(updateProfile) {\n      var newProfile;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              newProfile = _objectSpread(_objectSpread({}, profile), updateProfile);\n              mutate(newProfile, false);\n              _context2.next = 4;\n              return API.profile.patch(pick(newProfile, [\"desktopNotifsEnabled\", \"phoneNotifsEnabled\", \"phoneNumber\"]));\n\n            case 4:\n              mutate();\n              return _context2.abrupt(\"return\", newProfile);\n\n            case 6:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n\n    return function editProfile(_x) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var handleOk = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n      var value, newProfile, _e$response, _e$response2, _e$response2$data;\n\n      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              _context3.next = 2;\n              return form.validateFields();\n\n            case 2:\n              value = _context3.sent;\n              _context3.prev = 3;\n              _context3.next = 6;\n              return editProfile(value);\n\n            case 6:\n              newProfile = _context3.sent;\n              form.setFieldsValue(newProfile);\n              message.success(\"Your notification settings have been successfully updated\");\n              _context3.next = 14;\n              break;\n\n            case 11:\n              _context3.prev = 11;\n              _context3.t0 = _context3[\"catch\"](3);\n\n              if (((_e$response = _context3.t0.response) === null || _e$response === void 0 ? void 0 : _e$response.status) === 400 && ((_e$response2 = _context3.t0.response) === null || _e$response2 === void 0 ? void 0 : (_e$response2$data = _e$response2.data) === null || _e$response2$data === void 0 ? void 0 : _e$response2$data.message) === ERROR_MESSAGES.notificationService.registerPhone) {\n                form.setFields([{\n                  name: \"phoneNumber\",\n                  errors: [\"Invalid phone number\"]\n                }]);\n              }\n\n            case 14:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3, null, [[3, 11]]);\n    }));\n\n    return function handleOk() {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  return profile && /*#__PURE__*/_jsxs(_Fragment, {\n    children: [/*#__PURE__*/_jsx(HeaderTitle, {\n      children: /*#__PURE__*/_jsx(\"h1\", {\n        children: \"Notifications\"\n      })\n    }), /*#__PURE__*/_jsxs(Form, {\n      wrapperCol: {\n        span: 10\n      },\n      form: form,\n      initialValues: profile,\n      children: [/*#__PURE__*/_jsx(Form.Item, {\n        style: {\n          flex: 1\n        },\n        label: \"Enable notifications on all devices\",\n        name: \"desktopNotifsEnabled\",\n        valuePropName: \"checked\",\n        children: /*#__PURE__*/_jsx(Switch, {})\n      }), /*#__PURE__*/_jsx(Form.Item, {\n        shouldUpdate: true,\n        noStyle: true,\n        children: function children() {\n          return (form === null || form === void 0 ? void 0 : form.getFieldValue(\"desktopNotifsEnabled\")) && /*#__PURE__*/_jsx(DeviceNotifPanel, {});\n        }\n      }), /*#__PURE__*/_jsx(Form.Item, {\n        style: {\n          marginTop: \"30px\",\n          flex: 1\n        },\n        label: \"Enable SMS notifications\",\n        name: \"phoneNotifsEnabled\",\n        valuePropName: \"checked\",\n        children: /*#__PURE__*/_jsx(Switch, {})\n      }), /*#__PURE__*/_jsx(Form.Item, {\n        shouldUpdate: true,\n        noStyle: true,\n        children: function children() {\n          return (form === null || form === void 0 ? void 0 : form.getFieldValue(\"phoneNotifsEnabled\")) && /*#__PURE__*/_jsx(Form.Item, {\n            label: \"Phone #\",\n            name: \"phoneNumber\",\n            rules: [{\n              required: true,\n              message: \"Please input your number to enable text notifications\"\n            }],\n            children: /*#__PURE__*/_jsx(Input, {\n              placeholder: \"XXX-XXX-XXXX\"\n            })\n          });\n        }\n      })]\n    }), /*#__PURE__*/_jsx(Tooltip, {\n      title: \"Click for help guide\",\n      children: /*#__PURE__*/_jsx(QuestionCircleOutlined, {\n        style: {\n          \"float\": \"right\",\n          fontSize: \"25px\"\n        },\n        onClick: function onClick() {\n          return window.open(\"https://info.khouryofficehours.com/593f9eb67eb04abbb8008c285ed5a8dd\");\n        }\n      })\n    }), /*#__PURE__*/_jsx(Button, {\n      type: \"primary\",\n      onClick: handleOk,\n      style: {\n        marginBottom: \"15px\"\n      },\n      children: \"Save\"\n    }, \"submit\")]\n  });\n}\n\nfunction useThisDeviceEndpoint() {\n  var _useState = useState(null),\n      endpoint = _useState[0],\n      setEndpoint = _useState[1];\n\n  useEffect(function () {\n    _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n      return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              _context4.t0 = setEndpoint;\n              _context4.next = 3;\n              return getEndpoint();\n\n            case 3:\n              _context4.t1 = _context4.sent;\n              return _context4.abrupt(\"return\", (0, _context4.t0)(_context4.t1));\n\n            case 5:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, _callee4);\n    }))();\n  });\n  return endpoint;\n}\n\nfunction renderDeviceInfo(device, isThisDevice) {\n  if (device.name) {\n    return isThisDevice ? \"\".concat(device.name, \" (This Device)\") : device.name;\n  } else {\n    return isThisDevice ? \"This Device\" : \"Other Device\";\n  }\n}\n\nfunction DeviceNotifPanel() {\n  var _profile$desktopNotif;\n\n  var thisEndpoint = useThisDeviceEndpoint();\n\n  var _useSWR2 = useSWR(\"api/v1/profile\", /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5() {\n    return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n      while (1) {\n        switch (_context5.prev = _context5.next) {\n          case 0:\n            return _context5.abrupt(\"return\", API.profile.index());\n\n          case 1:\n          case \"end\":\n            return _context5.stop();\n        }\n      }\n    }, _callee5);\n  }))),\n      profile = _useSWR2.data,\n      mutate = _useSWR2.mutate;\n\n  var thisDesktopNotif = profile === null || profile === void 0 ? void 0 : (_profile$desktopNotif = profile.desktopNotifs) === null || _profile$desktopNotif === void 0 ? void 0 : _profile$desktopNotif.find(function (dn) {\n    return dn.endpoint === thisEndpoint;\n  });\n  return /*#__PURE__*/_jsxs(\"div\", {\n    children: [/*#__PURE__*/_jsxs(DeviceAddHeader, {\n      children: [/*#__PURE__*/_jsx(\"h3\", {\n        children: \"Your Devices\"\n      }), !thisDesktopNotif && /*#__PURE__*/_jsx(Tooltip, {\n        title: getNotificationState() === NotificationStates.browserUnsupported && \"Browser does not support notifications. Please use Chrome or Firefox, and not Incognito Mode.\",\n        children: /*#__PURE__*/_jsx(Button, {\n          onClick: /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6() {\n            var canNotify;\n            return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n              while (1) {\n                switch (_context6.prev = _context6.next) {\n                  case 0:\n                    _context6.next = 2;\n                    return requestNotificationPermission();\n\n                  case 2:\n                    canNotify = _context6.sent;\n\n                    if (canNotify === NotificationStates.notAllowed) {\n                      message.warning(\"Please allow notifications in this browser\");\n                    }\n\n                    if (!(canNotify === NotificationStates.granted)) {\n                      _context6.next = 8;\n                      break;\n                    }\n\n                    _context6.next = 7;\n                    return registerNotificationSubscription();\n\n                  case 7:\n                    mutate();\n\n                  case 8:\n                  case \"end\":\n                    return _context6.stop();\n                }\n              }\n            }, _callee6);\n          })),\n          disabled: getNotificationState() === NotificationStates.browserUnsupported,\n          style: {\n            marginBottom: \"4px\"\n          },\n          children: \"Add This Device\"\n        })\n      })]\n    }), /*#__PURE__*/_jsx(List, {\n      bordered: true,\n      dataSource: profile.desktopNotifs,\n      locale: {\n        emptyText: \"No Devices Registered To Receive Notifications\"\n      },\n      renderItem: function renderItem(device) {\n        return /*#__PURE__*/_jsx(List.Item, {\n          actions: [/*#__PURE__*/_jsx(MinusCircleOutlined, {\n            style: {\n              fontSize: \"20px\"\n            },\n            onClick: /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7() {\n              return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n                while (1) {\n                  switch (_context7.prev = _context7.next) {\n                    case 0:\n                      _context7.next = 2;\n                      return API.notif.desktop.unregister(device.id);\n\n                    case 2:\n                      mutate();\n\n                    case 3:\n                    case \"end\":\n                      return _context7.stop();\n                  }\n                }\n              }, _callee7);\n            }))\n          }, 0)],\n          children: /*#__PURE__*/_jsx(List.Item.Meta, {\n            title: renderDeviceInfo(device, device.endpoint === thisEndpoint),\n            description: \"Registered \".concat(device.createdAt.toLocaleDateString())\n          })\n        });\n      }\n    })]\n  });\n}","map":null,"metadata":{},"sourceType":"module"}